# 智能数据问答界面 2.0

基于 PRD 《智能问答界面重构专项》开发的动态分析叙事系统。

## 🚀 功能特性

### 核心功能
- **自然语言问答**: 支持多种问答意图识别
- **动态分析叙事**: 流式渲染图文并茂的分析报告
- **智能组件调用**: 根据意图自动选择合适的可视化组件

### 支持的查询类型
| 类型 | 示例问题 | 组件 |
|------|---------|------|
| 单指标查询 | "今年销售额是多少" | KPI卡片 |
| 趋势分析 | "近3个月销售趋势" | 折线图 |
| 维度对比 | "各地区销售额对比" | 柱状图 |
| 构成分析 | "销售渠道占比" | 饼图 |
| 异常检测 | "分析销售额异常原因" | 多图表组合 |
| 预测分析 | "预测下月销售额" | 预测线图 |

### 组件库
- **KPI卡片**: 主指标卡片、次要指标卡片、指标组
- **图表组件**: 折线图、柱状图、饼图、年度对比图、面积图、散点图、漏斗图、箱线图、地图、四象限图等
- **交互组件**: 追问按钮、快速问题入口
- **布局组件**: 侧边栏、消息气泡、输入框

### 数字员工团队

系统内置了多个专业数字员工，每个员工都有独特的专长，可以根据你的需求自动切换或手动选择：

| 数字员工 | 专长领域 | 核心能力 | 适用场景 |
|---------|---------|---------|---------|
| **Alisa** | SQL专家 · 理科生 | 精准SQL查询、结构化数据分析 | 快速定位字段、生成准确图表 |
| **Nora** | 语义推理 · 文科生 | 自然语言理解、业务故事化表达 | 复杂问题理解、多轮追问引导 |
| **归因哥** | 归因分析师 | 异常诊断、多维度归因分析 | 问题根因分析、可落地方案 |
| **可视化小王** | 数据可视化专家 | 最佳图表类型选择 | 数据故事可视化、图表设计 |
| **Emily** | 指标体系专家 | 业务指标体系构建、口径定义 | KPI定义、指标管理 |
| **Lisa** | 报表分析师 | 定期报表分析、经营洞察 | 周报月报、经营分析 |
| **预测君** | 预测分析师 | 时序预测、趋势分析 | 业务预测、趋势判断 |
| **数据卫士** | 数据质量专家 | 数据质量监控、异常检测 | 数据校验、质量保障 |
| **Kevin** | 增长分析师 | 用户增长、转化漏斗分析 | 增长策略、转化优化 |
| **运营小美** | 运营数据分析师 | 活动效果分析、用户行为洞察 | 运营决策、活动评估 |
| **福尔摩斯** | 数据侦探 | 异常追踪、线索链分析 | 深度调查、问题溯源 |
| **水晶球大师** | 预言家 | 数据预测、趋势占卜 | 未来预测、时机判断 |
| **Excel忍者** | 表格专家 | 透视表、多维交叉分析 | 数据汇总、快速分析 |
| **焦虑分析师** | 危机感大使 | 风险预警、压力测试 | 风险监控、提前预警 |
| **Chill哥** | 佛系数据师 | 长期趋势分析、淡定解读 | 宏观分析、长期视角 |
| **MC数据** | 数据说唱歌手 | 押韵分析、记忆化表达 | 趣味解读、印象深刻 |
| **时光旅人** | 同环比穿越者 | 历史数据对比、时间穿越 | 同比环比、历史对比 |
| **数据大厨** | 指标烹饪师 | 数据大餐、报表美食 | 综合分析、报表制作 |
| **数据八卦王** | 业务情报员 | 内幕消息、部门洞察 | 业务情报、内部分析 |

**智能切换机制**：
- 系统会根据你的问题自动识别最适合的数字员工
- 支持手动切换数字员工
- 每个员工都有独特的表达风格和分析视角

## 📦 技术栈

- **React 18** - UI框架
- **TypeScript** - 类型安全
- **Tailwind CSS** - 样式系统
- **Framer Motion** - 动画效果
- **Recharts** - 图表库
- **Lucide React** - 图标库
- **Vite** - 构建工具

## 🛠️ 快速开始

### 安装依赖
```bash
npm install
```

### 启动开发服务器
```bash
npm run dev
```

### 构建生产版本
```bash
npm run build
```

## 📁 项目结构

```
smart-qa/
├── src/
│   ├── components/        # UI组件
│   │   ├── KPICard.tsx       # KPI卡片组件
│   │   ├── Charts.tsx        # 图表组件
│   │   ├── MessageBubble.tsx # 消息气泡
│   │   ├── ChatInput.tsx     # 输入框
│   │   ├── ActionButtons.tsx # 追问按钮
│   │   └── Sidebar.tsx       # 侧边栏
│   ├── services/          # 业务逻辑
│   │   ├── intentEngine.ts   # 意图识别引擎
│   │   └── mockData.ts       # 模拟数据
│   ├── types/             # 类型定义
│   │   └── index.ts
│   ├── App.tsx            # 主应用
│   ├── main.tsx           # 入口文件
│   └── index.css          # 全局样式
├── public/
├── package.json
└── README.md
```

## 🎨 设计规范

### 色彩系统
- **主色**: #3b82f6 (Primary Blue)
- **成功**: #10b981 (Success Green)
- **警告**: #f59e0b (Warning Orange)
- **危险**: #ef4444 (Danger Red)

### 组件层级
- **L1 意图**: 简单查询 → KPI卡片
- **L2 意图**: 分析查询 → 图表 + 文字叙事
- **L3 意图**: 深度分析 → 多图表组合

## 🔄 意图识别映射

系统会根据用户问题中的关键词自动识别意图并选择合适的可视化组件：

```typescript
// 示例：用户输入 "今年销售额是多少"
// 意图识别结果:
{
  type: 'single_metric',
  level: 'L1',
  suggestedComponents: ['kpi', 'kpi-group', 'line-chart']
}
```

## 💡 核心亮点功能

### ⚡ 实时流式渲染 - 秒回体验

**业界领先的实时渲染技术**，让数据分析和图表展示实现真正的"秒回"体验。

**技术实现**：
- 基于 DeepSeek API 的 Server-Sent Events (SSE) 流式响应
- 实时解析流式内容，即时提取图表、表格、KPI 等结构化数据
- 图表在流式输出过程中即可渲染，无需等待完整响应

**使用体验**：
```typescript
// 用户提问："近3个月销售趋势"
// 系统立即开始流式输出：
// 1. 文字解释（打字机效果）
// 2. 图表 JSON 被实时解析 → 立即渲染图表
// 3. 表格数据被实时提取 → 立即渲染表格
// 4. 整个过程流畅无卡顿，用户看到内容逐步呈现
```

**技术细节**：
- 使用 `parseRealtimeContent()` 实时解析 `[chart:{...}]` 格式
- 支持嵌套 JSON 解析，自动匹配大括号
- 图表组件支持延迟动画，提升视觉体验
- 节流优化：每 100ms 或每 10 个 chunk 更新一次 UI，平衡流畅度和性能
- 智能内容块分离：自动识别文本、图表、表格、KPI，按位置排序渲染

**性能优化**：
- 流式响应过程中即可开始渲染，无需等待完整响应
- 使用 React 虚拟 DOM 和 Framer Motion 优化动画性能
- 支持大量数据点的图表渲染（1000+ 数据点流畅无卡顿）

### 🤖 DeepSeek AI 智能问答集成

#### 配置 DeepSeek API

1. **获取 API Key**：
   - 访问 [DeepSeek API 文档](https://api-docs.deepseek.com/zh-cn/)
   - 注册账号并获取 API Key

2. **配置 API Key**：
   
   编辑 `src/services/deepseekApi.ts`：
   ```typescript
   const DEEPSEEK_API_KEY = 'your-api-key-here';
   ```

3. **配置代理（开发环境）**：
   
   项目已配置 Vite 代理，无需额外配置：
   ```typescript
   // vite.config.ts
   proxy: {
     '/api/deepseek': {
       target: 'https://api.deepseek.com',
       changeOrigin: true,
       rewrite: (path) => path.replace(/^\/api\/deepseek/, ''),
     }
   }
   ```

4. **生产环境部署**：
   
   需要在后端配置代理或直接调用 DeepSeek API（注意 CORS 限制）

#### 智能问答交互流程

```
用户输入问题
    ↓
意图识别引擎（自动选择数字员工）
    ↓
构建对话历史 + 知识库上下文 + 用户记忆
    ↓
调用 DeepSeek API（流式响应，支持联网搜索）
    ↓
实时解析响应内容（每 100ms 更新一次）
    ├─ 文本 → 打字机效果渲染（15ms/字符）
    ├─ [chart:{...}] → 实时渲染图表（支持所有类型）
    ├─ [kpi:{...}] → 实时渲染 KPI 卡片（带趋势动画）
    ├─ [table:...] → 实时渲染表格（Markdown 格式）
    ├─ [choices:...] → 实时渲染交互选项（可点击）
    └─ [switch:...] → 实时渲染员工切换按钮
    ↓
用户可继续追问、下钻分析或切换数字员工
```

#### 对话上下文管理

**智能上下文保持**：
- 自动维护对话历史（最多保留最近 10 轮对话）
- 支持多轮追问和上下文理解
- 自动识别用户意图变化，切换数字员工

**用户记忆系统**：
- 记录用户关注的核心指标
- 学习用户常用查询模式
- 生成个性化推荐问题
- 跨会话保持用户偏好

#### 图表输出格式

DeepSeek 返回的图表数据格式：

```json
[chart:{
  "type": "line",
  "title": "近3个月销售趋势",
  "data": [
    {"date": "2024-01", "value": 320},
    {"date": "2024-02", "value": 380},
    {"date": "2024-03", "value": 420}
  ],
  "xKey": "date",
  "yKeys": [{"key": "value", "name": "销售额"}]
}]
```

**支持的图表类型**：
- `line` / `line-chart` - 折线图（支持多系列、面积填充）
- `bar` / `bar-chart` - 柱状图（支持横向、堆叠）
- `pie` / `pie-chart` - 饼图（支持环形图、百分比显示）
- `area` / `area-chart` - 面积图（支持渐变填充）
- `scatter` / `scatter-chart` - 散点图（支持气泡图、四象限）
- `funnel` / `funnel-chart` - 漏斗图（支持转化率显示）
- `box-plot` - 箱线图（支持异常值标注）
- `map` / `map-chart` - 地图（支持热力图、区域分布）
- `quadrant` / `quadrant-chart` - 四象限图（支持象限标注）
- `year-comparison` - 年度对比图（支持同比环比）
- **任何其他类型** - 自动适配渲染（通用渲染器）

**图表特性**：
- 响应式布局，自动适配屏幕尺寸
- 支持图表下钻交互
- 支持图表联动过滤
- 支持数据导出
- 支持图表切换（图表/代码视图）

### 🎨 交互式内容解析

系统支持多种交互组件，让对话更智能：

**1. 选择题组件**：
```
[choices:选项A|选项B|选项C]
```
渲染为可点击的选项按钮

**2. 快速操作按钮**：
```
[actions:查看详情|下钻分析|导出报告]
```
渲染为操作按钮组

**3. 数字员工切换**：
```
[switch:归因哥]
```
点击后自动切换到对应的数字员工

**4. KPI 卡片**：
```
[kpi:{"label":"销售额","value":1250000,"trend":{"value":12.5,"direction":"up"}}]
```
实时渲染为精美的 KPI 卡片

**5. 表格数据**：
```
| 区域 | 销售额 | 增长率 |
|------|--------|--------|
| 华东 | ¥2450万 | +12% |
| 华南 | ¥1890万 | +8% |
```
自动识别并渲染为表格

### 🚀 智能图表自动适配

**通用图表渲染器**：
- 自动识别未知图表类型
- 根据数据结构智能选择渲染方式
- 单个数值字段 → 柱状图
- 多个数值字段 → 折线图/面积图
- 有 name 和 value → 饼图
- 其他情况 → 数据表格

**参数自动推断**：
- 自动识别 `xKey`（从 date、month、name 等常见字段）
- 自动识别 `yKey`/`yKeys`（从 value、sales、amount 等数值字段）
- 支持自定义字段名映射

### 📊 实时数据可视化

**流式图表渲染**：
- 图表在流式输出过程中即可渲染
- 支持动画效果和延迟加载
- 自动适配响应式布局

**下钻交互**：
- 点击图表数据点可触发下钻分析
- 自动生成下钻查询
- 支持多维度下钻

**图表联动**：
- 多个图表可联动过滤
- 支持时间范围选择器
- 支持维度切换

### 🔍 智能意图识别

**自动数字员工切换**：
- 根据问题关键词自动识别最适合的数字员工
- 支持手动切换数字员工
- 每个员工有独特的表达风格
- 支持员工推荐（当前员工可推荐其他员工）

**意图识别示例**：
```typescript
// 用户："为什么销售额下降了"
// 系统识别 → 切换到"归因哥"数字员工

// 用户："用图表展示销售趋势"
// 系统识别 → 切换到"可视化小王"数字员工

// 用户："预测下月销售额"
// 系统识别 → 切换到"预测君"数字员工
```

**意图识别引擎**：
- 基于关键词匹配和语义理解
- 支持模糊查询和同义词识别
- 自动识别查询类型（单指标、趋势、对比、归因等）
- 智能推荐可视化组件

### 💾 用户记忆系统

**智能学习**：
- 记录用户关注的核心指标
- 学习用户常用查询模式
- 生成个性化推荐问题
- 分析用户查询频率和偏好

**记忆持久化**：
- 使用 localStorage 持久化存储
- 跨会话保持用户偏好
- 支持记忆导出和导入
- 自动清理过期记忆

**个性化推荐**：
- 基于用户历史生成推荐问题
- 根据用户关注点推荐相关分析
- 智能提示用户可能感兴趣的数据

### 🌐 联网搜索集成

**智能搜索触发**：
- 自动识别需要实时信息的问题
- 支持联网搜索最新数据
- 搜索结果自动整合到回答中

**搜索场景**：
- 市场行情查询
- 竞品信息对比
- 行业数据参考
- 实时新闻整合

### 📱 移动端适配

**响应式设计**：
- 完美适配手机、平板、桌面
- 支持触摸手势操作
- 移动端优化的交互体验

**移动端特性**：
- 手势控制页面（实验性功能）
- 移动端专用测试页面
- 优化的移动端图表显示

## 🎯 使用指南

### 基础使用

1. **启动项目**：
   ```bash
   npm install
   npm run dev
   ```

2. **访问应用**：
   打开浏览器访问 `http://localhost:3000`

3. **开始对话**：
   - 在输入框输入你的问题
   - 系统会自动选择最适合的数字员工
   - 实时看到 AI 的回答和图表渲染

### 使用示例

#### 示例 1: 单指标查询

**用户输入**：
```
今年销售额是多少
```

**系统响应**：
- 自动切换到 "Emily"（指标体系专家）
- 实时渲染 KPI 卡片，显示销售额数值
- 显示趋势对比（同比、环比）
- 提供追问选项：查看详情、对比分析、下钻维度

#### 示例 2: 趋势分析

**用户输入**：
```
近3个月销售趋势
```

**系统响应**：
- 自动切换到 "可视化小王"（数据可视化专家）
- 实时渲染折线图，展示月度趋势
- 自动标注关键数据点
- 提供交互选项：切换时间范围、对比同期、预测未来

#### 示例 3: 异常归因

**用户输入**：
```
为什么11月销售额下降了
```

**系统响应**：
- 自动切换到 "归因哥"（归因分析师）
- 实时渲染多维度分析图表
- 自动下钻到区域、渠道、产品等维度
- 提供根因分析和改进建议

#### 示例 4: 复杂分析报告

**用户输入**：
```
全面分析今年业务情况
```

**系统响应**：
- 自动切换到 "Nora"（语义推理专家）
- 流式输出包含：
  - 多个 KPI 卡片（销售额、订单量、利润率等）
  - 多个图表（趋势图、对比图、占比图等）
  - 数据表格（多维度对比）
  - 业务洞察和建议
- 所有内容实时渲染，无需等待

### 最佳实践

#### 1. 提问技巧

**✅ 好的提问方式**：
- "近3个月销售额趋势" - 明确的时间范围和指标
- "各地区销售额对比" - 明确的维度和对比需求
- "为什么11月销售额下降了" - 明确的问题和指标

**❌ 避免的提问方式**：
- "看看数据" - 太模糊，系统会反问确认
- "分析一下" - 缺少具体对象，系统会提供选项

#### 2. 图表输出优化

**在 DeepSeek 的回复中使用图表格式**：
```json
[chart:{
  "type": "bar",
  "title": "各区域销售额",
  "data": [
    {"name": "华东", "value": 2450},
    {"name": "华南", "value": 1890}
  ],
  "xKey": "name",
  "yKey": "value"
}]
```

**KPI 卡片格式**：
```json
[kpi:{
  "label": "销售额",
  "value": 1250000,
  "prefix": "¥",
  "unit": "元",
  "trend": {
    "value": 12.5,
    "direction": "up",
    "label": "环比上月"
  }
}]
```

#### 3. 交互组件使用

**选择题组件**：
```
[choices:选项A|选项B|选项C]
```

**操作按钮**：
```
[actions:查看详情|下钻分析|导出报告]
```

**数字员工切换**：
```
这个问题让 [switch:归因哥] 来分析更专业
```

#### 4. 性能优化建议

- 图表数据量控制在 1000 条以内，确保流畅渲染
- 复杂分析分步骤进行，避免一次性输出过多内容
- 使用下钻功能逐步深入，而不是一次性查询所有维度

### 故障排除

#### DeepSeek API 调用失败

**问题**：无法连接到 DeepSeek API

**解决方案**：
1. 检查 API Key 是否正确配置
2. 检查网络连接和代理设置
3. 查看浏览器控制台错误信息
4. 确认 API 额度是否充足

#### 图表不显示

**问题**：图表 JSON 格式正确但不显示

**解决方案**：
1. 检查 JSON 格式是否正确（注意大括号匹配）
2. 确认 `type` 字段是否存在
3. 确认 `data` 字段是否为数组且不为空
4. 检查浏览器控制台是否有错误

#### 实时渲染卡顿

**问题**：流式输出时界面卡顿

**解决方案**：
1. 减少单次输出的内容量
2. 检查是否有大量图表同时渲染
3. 优化数据结构，减少嵌套层级
4. 使用浏览器性能分析工具定位瓶颈

### 配置 DeepSeek API

1. **修改 API Key**：
   
   编辑 `src/services/deepseekApi.ts`：
   ```typescript
   const DEEPSEEK_API_KEY = 'your-deepseek-api-key';
   ```

2. **配置环境变量（推荐）**：
   
   创建 `.env` 文件：
   ```env
   VITE_DEEPSEEK_API_KEY=your-api-key-here
   ```
   
   然后在代码中使用：
   ```typescript
   const DEEPSEEK_API_KEY = import.meta.env.VITE_DEEPSEEK_API_KEY;
   ```

3. **生产环境配置**：
   
   如果部署到生产环境，需要：
   - 配置后端代理（避免 CORS 问题）
   - 或使用服务器端调用 DeepSeek API

### 高级功能

#### 自定义数字员工

编辑 `src/services/agents.ts` 添加新的数字员工：

```typescript
{
  id: 'custom-agent',
  name: '自定义员工',
  title: '专业领域',
  badge: '标签',
  description: '员工描述',
  suggestedQuestions: [
    { label: '问题1', query: '查询语句1' },
    { label: '问题2', query: '查询语句2' },
  ],
}
```

#### 自定义图表类型

系统支持任何图表类型，会自动适配。如果需要自定义渲染逻辑：

1. 在 `src/components/Charts.tsx` 中添加新的图表组件
2. 在 `SmartChart` 的 switch 语句中添加对应的 case
3. 或使用通用渲染器自动适配

#### 扩展知识库

编辑 `src/services/deepseekApi.ts` 中的 `YIWEN_KNOWLEDGE_BASE` 常量，添加你的业务知识。

## 📝 License

MIT


